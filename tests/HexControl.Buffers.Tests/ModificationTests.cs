using HexControl.Buffers.Chunks;
using HexControl.Buffers.History.Changes;
using Xunit;

namespace HexControl.Buffers.Tests;

public class ModificationTests
{
    private readonly ByteBuffer _buffer;

    public ModificationTests()
    {
        byte[] data =
        {
            0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70,
            0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66,
            0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76,
            0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x6B, 0x69, 0x70, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C,
            0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62,
            0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72,
            0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68,
            0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78,
            0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E,
            0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64,
            0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74,
            0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A,
            0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A,
            0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70,
            0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66,
            0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76,
            0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C,
            0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62,
            0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72,
            0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68,
            0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78,
            0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E,
            0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64,
            0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74,
            0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A,
            0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A,
            0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70,
            0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66,
            0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76,
            0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C,
            0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62,
            0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72,
            0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68,
            0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78,
            0x79, 0x7A
        };
        _buffer = new MemoryBuffer(data);
    }

    [Fact]
    public void Remove_At_Middle()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4, 5, 6, 7, 8, 9};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new RemoveFromMemoryChange(3, 2);
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {1, 2, 3, 6, 7, 8, 9}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Remove_At_Start()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4, 5, 6, 7, 8, 9};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new RemoveFromMemoryChange(0, 2);
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {3, 4, 5, 6, 7, 8, 9}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Remove_At_End()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4, 5, 6, 7, 8, 9};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new RemoveFromMemoryChange(originalBuffer.Length - 2, 2);
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {1, 2, 3, 4, 5, 6, 7}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Write_At_Middle()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4, 5, 6, 7, 8, 9};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new WriteToMemoryChange(3, new byte[] {0, 0});
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {1, 2, 3, 0, 0, 6, 7, 8, 9}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Write_GrowStart()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4, 5, 6, 7, 8, 9};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new WriteToMemoryChange(-3, new byte[] {5, 4, 3, 2, 1});
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {5, 4, 3, 2, 1, 3, 4, 5, 6, 7, 8, 9}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Write_GrowEnd()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4, 5, 6, 7, 8, 9};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new WriteToMemoryChange(chunk.Bytes.Length - 2, new byte[] {5, 4, 3, 2, 1});
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {1, 2, 3, 4, 5, 6, 7, 5, 4, 3, 2, 1}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Write_GrowBoth()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new WriteToMemoryChange(-2, new byte[] {3, 2, 1, 2, 3, 4, 3, 2});
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {3, 2, 1, 2, 3, 4, 3, 2}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Insert_AtMiddle()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new InsertToMemoryChange(2, new byte[] {3, 2, 1});
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {1, 2, 3, 2, 1, 3, 4}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Insert_AtStart()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new InsertToMemoryChange(0, new byte[] {3, 2, 1});
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {3, 2, 1, 1, 2, 3, 4}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }

    [Fact]
    public void Insert_AtEnd()
    {
        var originalBuffer = new byte[] {1, 2, 3, 4};

        var chunk = new MemoryChunk(_buffer, originalBuffer.ToArray());
        var mod = new InsertToMemoryChange(4, new byte[] {3, 2, 1});
        mod.Apply(_buffer, null!, chunk);
        Assert.Equal(new byte[] {1, 2, 3, 4, 3, 2, 1}, chunk.Bytes);

        mod.Revert(_buffer, null!, chunk);
        Assert.Equal(originalBuffer, chunk.Bytes);
    }
}